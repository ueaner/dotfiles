#!/usr/bin/env bash
#
# This script handles Broadcom wireless connectivity issues on a Macbook with Fedora 41+.
#
# Network:
# 1. Wired network
# 2. USB tethering (Settings -> Portable hotspot -> USB tethering)
# 3. Bluetooth tethering (Settings -> Portable hotspot -> Bluetooth tethering)
#
# @depends
# - https://github.com/ueaner/dotfiles/blob/main/bin/kernel-rpm-downloader
# - jq
#
#   ~/bin/
#   ├── kernel-broadcom-wl
#   └── kernel-rpm-downloader
#
# Cases:
#                    Fedora    kernel    kernel-headers
#    system init       41      6.11.4      6.11.3
#  packages upgrade    41      6.12.1      6.12.4
#  packages upgrade    41      6.12.13     6.12.4
#    system upgrade    42      6.13.1      6.12.4

# Check if Wi-Fi is available
if ! lspci | grep -i broadcom | grep -q -i wireless; then
    echo "Non-Broadcom wireless network adapter, no need to continue."
    exit 0
fi
if nmcli conn show --active | grep -q -i wifi; then
    echo "Already connected to the wireless network, no need to continue."
    exit 0
fi

# NOTE: 0. Determine the kernel-headers version

# 获取将要安装与当前 kernel 版本最接近的 kernel-headers 和 kernel
fver=$(rpm -E %fedora)
kver=$(rpm -qa --qf '%{NAME}-%{VERSION}-%{RELEASE}\n' | grep -o -E '^kernel-[0-9]+.[0-9]+' | head -1)
updates=$(
    curl -s "https://bodhi.fedoraproject.org/updates/?packages=kernel-headers&status=stable&releases=F${fver}" |
        jq -r '.updates[].title' |
        grep -Ew '100|200|300' |
        awk '{
    out = ""
    for (i = 1; i <= NF; i++) {
        if ($i ~ /^kernel-[0-9]/ || $i ~ /^kernel-headers-[0-9]/) {
            out = out (out ? " " : "") $i
        }
    }
    if (out) print out
}' | grep "$kver"
)

read -r k_target h_target <<<"$updates"

k_target="${k_target}.$(uname -m)"
h_target="${h_target}.$(uname -m)"

# NOTE: 1. Check if kmod-wl is installed

k_version=$(echo "$k_target" | sed -r 's/kernel-//')
akmod_wl_version=$(rpm -q akmod-wl | sed 's/^akmod-wl-//')

# eg: kmod-wl-6.15.3-200.fc42.x86_64-6.30.223.271-58.fc42.x86_64
kmod_wl="kmod-wl-${k_version}-${akmod_wl_version}"
if rpm --quiet -q "$kmod_wl" >/dev/null; then
    echo "$kmod_wl already installed"
    echo "Reboot your computer and enjoy the Wi-Fi network."
    exit 0
fi

# NOTE: 2. Download and install kernel* packages

[[ -n "$XDG_BACKUP_DIR" ]] && download_dir="$XDG_BACKUP_DIR/archives/$k_target" || download_dir="$HOME/.cache/archives/$k_target"
mkdir -p "$download_dir"
cd "$download_dir" || exit 1

echo "Download $k_target and $h_target packages"
~/bin/kernel-rpm-downloader "$k_target" "$h_target" --dir="$download_dir"
ret=$?
if [[ $ret -ne 0 ]]; then
    echo "Failed to download $k_target and $h_target packages"
    exit 1
fi

# Ignore upgrade of kernel* packages
sudo dnf upgrade -y --refresh --exclude=kernel\*

echo "Install $k_target and $h_target"

# Allow install/update/downgrade of kernel* packages
sudo sed -i '/exclude=kernel/d' /etc/dnf/dnf.conf
# shellcheck disable=SC2086,SC2046
sudo dnf install -y kernel*.$(uname -m).rpm
# Ignore install/update/downgrade of kernel* packages
echo 'exclude=kernel*' | sudo tee -a /etc/dnf/dnf.conf

# NOTE: 3. Install `broadcom-wl` and kmod-wl packages

sudo dnf install -y akmods akmod-wl broadcom-wl

echo "kmod-wl package state:"
rpm -qa | grep kmod-wl

# Automatic build kmods for wl kernel module
sudo akmods

# NOTE: 4. Check if the new kmod-wl build was successful

akmod_wl_version=$(rpm -q akmod-wl | sed 's/^akmod-wl-//')
kmod_wl="kmod-wl-${k_version}-${akmod_wl_version}"
if rpm --quiet -q "$kmod_wl"; then
    echo "$kmod_wl installed"

    echo "Set next boot to use kernel-$k_version by default"
    sudo grubby --set-default "/boot/vmlinuz-$k_version"
    sudo grubby --default-kernel
    echo "Congratulations, now just reboot your computer and enjoy the Wi-Fi network."
    exit 0
fi

# NOTE: 5. Installation failed

cat <<EOF
$kmod_wl installation failed.
See links below (Waiting for RPM Fusion to patch akmod-wl):
- [Fedora Discussion]: https://discussion.fedoraproject.org/ tags: #broadcom #wifi #macbook #f${fver}
- [RPM Fusion Bugzilla]: https://bugzilla.rpmfusion.org/buglist.cgi?bug_status=all&component=broadcom-wl&component=wl-kmod&order=bug_id%20DESC&product=Fedora&version=f${fver}
- [RPM Fusion wl-kmod]: https://github.com/rpmfusion/wl-kmod
EOF

if [[ "$(uname -r)" == "$k_version" ]]; then
    exit 1
fi

cat <<EOF

You may want to remove the newly installed kernel* $k_version packages.
Ways to remove the kernel:

    # Allow install/update/downgrade of kernel* packages
    sudo sed -i '/exclude=kernel/d' /etc/dnf/dnf.conf
    # Remove the newly installed kernel* packages
    rpm -qa | grep kernel | grep $k_version | xargs sudo dnf remove -y
    # Checking
    rpm -qa | grep kernel | sort

    # Ignore install/update/downgrade of kernel* packages
    echo 'exclude=kernel*' | sudo tee -a /etc/dnf/dnf.conf

EOF

exit 1
