#!/usr/bin/env bash
#
# Download `kernel-headers` and `kernel` packages.
#

help() {
    cat <<EOF
kernel rpm downloader

Usage: kernel-rpm-downloader <kernel-xxx> [<kernel-headers-xxx>] --dir=/path/to/download/dir

    --dir                    Set directory used for downloading packages to.
                             The default location is the <kernel-xxx> directory under the current working directory.

    -h, --help               Show this message

Example:

    kernel-rpm-downloader kernel-6.11.3-300.fc41.x86_64
    kernel-rpm-downloader kernel-6.13.4-200.fc41.x86_64 kernel-headers-6.13.3-200.fc41.x86_64 --dir=/tmp
EOF
}

dir=
kernel_target=
kernel_headers_target=

if [[ $# -eq 0 ]]; then
    help
    exit 1
fi

while [[ $# -gt 0 ]]; do
    case "$1" in
    -h | --help)
        help
        exit 0
        ;;
    --dir)
        dir=$2
        shift 2
        ;;
    --dir=*)
        dir=$(echo "$1" | cut -d= -f2)
        if [[ "$dir" == "~"* ]]; then
            # Replace ~ with $HOME
            dir="${HOME}${dir:1}"
        fi
        shift
        ;;
    *)
        if [[ $1 =~ ^kernel-[0-9]+ ]]; then
            kernel_target=$1
        elif [[ $1 =~ ^kernel-headers-[0-9]+ ]]; then
            kernel_headers_target=$1
        fi
        shift
        ;;
    esac
done

# The kernel format is similar to the output of `rpm -q kernel`
# eg: kernel-6.11.3-300.fc41.x86_64
if [[ -z "$kernel_target" ]]; then
    # kernel=$(rpm -q kernel)
    echo "The argument format is similar to the output of \`rpm -q kernel\`"
    help
    exit 1
fi

# The kernel_ver format is similar to the output of `uname -r`
# eg: 6.11.3-300.fc41.x86_64
kernel_ver=$(echo "$kernel_target" | sed -r 's/kernel-//')
# Replace the first "-" and the last "." to "/"
# eg: 6.11.3/300.fc41/x86_64
kernel_slash_ver=$(echo "$kernel_ver" | tr "-" "/" | sed -r 's/(.*)\./\1\//')

kernel_headers_ver="$kernel_ver"
kernel_headers_slash_ver="$kernel_slash_ver"
if [[ -n "$kernel_headers_target" ]]; then
    kernel_headers_ver=$(echo "$kernel_headers_target" | sed -r 's/kernel-headers-//')
    kernel_headers_slash_ver=$(echo "$kernel_headers_ver" | tr "-" "/" | sed -r 's/(.*)\./\1\//')
fi

packages=(
    kernel
    kernel-core
    kernel-devel
    kernel-devel-matched
    kernel-modules
    kernel-modules-core
    kernel-modules-extra
    kernel-tools
    kernel-tools-libs
)

# https://packages.fedoraproject.org/pkgs/kernel-headers/
rpms=("$(printf "https://kojipkgs.fedoraproject.org/packages/kernel-headers/%s/%s-%s.rpm" "$kernel_headers_slash_ver" "kernel-headers" "$kernel_headers_ver")")

for pkg in "${packages[@]}"; do
    rpms+=("$(printf "https://kojipkgs.fedoraproject.org/packages/kernel/%s/%s-%s.rpm" "$kernel_slash_ver" "$pkg" "$kernel_ver")")
done

if [[ -z "$dir" ]]; then
    dir="./$kernel_target"
fi
mkdir -p "$dir"
cd "$dir" || exit 1

printf '%s\n' "${rpms[@]}"
wget -c "${rpms[@]}"
ret=$?

echo "Download to $dir directory"

exit $ret
