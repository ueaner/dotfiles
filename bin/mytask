#!/usr/bin/env bash
# @depends: go, yq

echo "$$ mytask: ---------- $(date "+%Y-%m-%d %T.%6N") ----------" >>/tmp/mytask.log

# shellcheck source=base.sh
source ~/bin/base.sh

### check-update kernel-headers

function check-update-kernel-headers() {
    latest_version=$(kernel-headers-latest-version)
    current_version=$(rpm -q --queryformat '%{name}-%{version}-%{release}' kernel-headers)

    if [[ "$latest_version" == "null" ]] || version-lte "$latest_version" "$current_version"; then
        printf "Fedora kernel-headers: no updates available\n" >>/tmp/mytask.log
        return
    fi

    ignore_versions=(
        # https://discussion.fedoraproject.org/t/broadcom-wl-not-working-after-upgrading-kernel-to-6-12-4/139948
        # https://bugzilla.rpmfusion.org/show_bug.cgi?id=7130
        # https://github.com/rpmfusion/wl-kmod/commit/16a67f7
        "kernel-headers-6.12.4-200.fc41"
    )

    for item in "${ignore_versions[@]}"; do
        if [[ "$item" == "$latest_version" ]]; then
            echo "Fedora kernel-headers: ignore $item" >>/tmp/mytask.log
            return
        fi
    done

    printf "Fedora kernel-headers: updates available\n%s\n" "$latest_version" >>/tmp/mytask.log
    # shellcheck source=/dev/null
    source "$HOME/.local/etc/token.sh"
    "$HOME/bin/sendmail.go" "Fedora kernel-headers updates available" <<EOF
${latest_version}


1. See:

    - https://src.fedoraproject.org/rpms/kernel-headers
    - [Fedora Discussion]: https://discussion.fedoraproject.org/ #broadcom #wifi #f${VERSION_ID} #macbook
    - [RPM Fusion Bugzilla]: https://bugzilla.rpmfusion.org/buglist.cgi?bug_status=all&component=broadcom-wl&component=wl-kmod&order=bug_id%20DESC&product=Fedora&version=f41&version=f40
    - [RPM Fusion wl-kmod]: https://github.com/rpmfusion/wl-kmod

2. Comment out the "exclude=kernel* kernel-*" line in the "/etc/dnf/dnf.conf" file.

3. Upgrading Kernel:

    sudo dnf upgrade --refresh
    sudo dnf update # OR ~/bin/kernel-rpm-downloader ${latest_version} && sudo dnf install ~/${latest_version}/*.rpm
    sudo akmods
    reboot

EOF
}

check-update-kernel-headers

### Check for updates to the Fedora release

function check-update-fedora-release() {
    # https://fedorapeople.org/groups/schedule/f-42/f-42-key-tasks.html
    releases=(
        f42 2025-04-22
        f43 2025-11-11
    )

    ver=$(($(awk '{print $3}' </etc/redhat-release) + 1))
    check=false
    release_date=

    # 0-based indexing
    index_offset=0
    if [[ -n "$ZSH_VERSION" && ! -o KSH_ARRAYS ]]; then
        # 1-based indexing
        index_offset=1
    fi

    # Set Zsh arrays to be zero indexed
    # This is how KSH and Bash behave
    # [[ -n "$ZSH_VERSION" ]] && setopt KSH_ARRAYS
    for ((i = 0; i < ${#releases[@]} / 2; i++)); do
        fversion=${releases[i * 2 + $index_offset]}
        fdate=${releases[i * 2 + 1 + $index_offset]}
        if [[ "${fversion}" == "f${ver}" ]]; then
            release_date=$fdate
            if version-lte "${fdate}" "$(date '+%Y-%m-%d')"; then
                check=true
                break
            fi
        fi
    done
    # [[ -n "$ZSH_VERSION" ]] && unsetopt KSH_ARRAYS

    if ! $check; then
        echo "Fedora $ver Non-stable, $release_date" >>/tmp/mytask.log
        return
    fi

    # ver=$(expr "$(awk '{print $3}' </etc/redhat-release)" + 1)
    httpcode=$(curl --silent --head "https://mirror.nyist.edu.cn/fedora/releases/$ver/" | awk '/^HTTP/{print $2}')

    if [ "$httpcode" != "200" ]; then
        echo "Fedora $ver Unreleased, $httpcode" >>/tmp/mytask.log
        return
    fi

    echo "Fedora $ver Released" >>/tmp/mytask.log
    # shellcheck source=/dev/null
    source "$HOME/.local/etc/token.sh"
    "$HOME/bin/sendmail.go" "Fedora $ver Released" <<EOF

https://fedoraproject.org/zh-Hans/workstation/download

https://mirror.nyist.edu.cn/fedora/releases/$ver/

EOF
}

check-update-fedora-release
