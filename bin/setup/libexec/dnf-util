#!/usr/bin/env bash
# DNF Utility Helper
#
# dnf-util [--mirror=<ustc|tsinghua|official>] [--repo=<fedora|rpmfusion>] [--clean] [--config]
# dnf-util [-m <ustc|tsinghua|official>] [-r <fedora|rpmfusion>] [-x] [-c]

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]:-$0}")" && pwd)"
. "$SCRIPT_DIR/../lib/init"

help() {
    cat <<EOF
DNF Utility Helper

Usage: dnf-util [options]

Show dnf summary (Default behavior when no other options)

    -m                       Mirror: ustc | tsinghua | official

    -r                       Repository: all (defaults) | fedora | rpmfusion

    -c                       Rewrite /etc/dnf/dnf.conf configuration contents

    -x                       Clean up dnf unused repositories

    -h                       Show this message

Example:

    dnf-util -m ustc -r fedora
    dnf-util -m ustc -r all
    dnf-util -m ustc
    dnf-util -m ustc -x
    dnf-util -m tsinghua
    dnf-util
    dnf-util -m ustc -x -c

EOF
}

# If a character is followed by a colon, it indicates that this specific option requires an argument.
OPTSTRING=":m:r:cxh"

mirror=
repo=
config=false
clean=false
no_option=true

defaults_dnfconf=$(
    cat <<EOF
[main]
gpgcheck=True
installonly_limit=2
clean_requirements_on_remove=True
best=False
skip_if_unavailable=True

exclude=kernel*
EOF
)

while getopts ${OPTSTRING} opt; do
    case ${opt} in
    m)
        mirror=$OPTARG
        if [[ "$mirror" != "ustc" && "$mirror" != "tsinghua" && "$mirror" != "official" ]]; then
            error "Argument must be one of [ustc | tsinghua | official]."
            exit 1
        fi
        no_option=false
        ;;
    r)
        repo=$OPTARG
        [[ -z "$repo" ]] && repo=all
        if [[ "$repo" != "all" && "$repo" != "fedora" && "$repo" != "rpmfusion" ]]; then
            error "Argument must be one of [all | fedora | rpmfusion]."
            exit 1
        fi
        no_option=false
        ;;
    c)
        config=true
        no_option=false
        ;;
    x)
        clean=true
        no_option=false
        ;;
    h)
        help
        exit 0
        ;;
    :)
        error "Option -${OPTARG} requires an argument."
        exit 1
        ;;
    ?)
        error "Invalid option: -${OPTARG}."
        exit 1
        ;;
    esac
done

shift $((OPTIND - 1))

# --- 参数逻辑检查 ---
if [[ -n "$repo" && -z "$mirror" && "$no_option" == false ]]; then
    # 如果指定了 repo 但没指定 mirror，且不是纯查询模式
    if [[ "$config" == false && "$clean" == false ]]; then
        error "Please specify a mirror (-m) for the repository (-r)."
        exit 1
    fi
fi

# --- 开始执行 ---
if [[ -n "$mirror" ]]; then
    section "Configuring DNF (Fedora)"
    info "Setting ${FG_MAGENTA}$repo${C_RESET} repositories mirror to ${FG_MAGENTA}$mirror${C_RESET}..."
fi

# --- RPM Fusion 安装 ---
if [[ "$repo" == "all" || "$repo" == "rpmfusion" ]]; then
    if ! rpm --quiet -q rpmfusion-free-release; then
        # https://rpmfusion.org/Configuration#Command_Line_Setup_using_rpm
        # https://rpmfusion.org/keys#Verify_GPG_signatures_on_install
        # preinstalled by fedora 41
        task "Installing RPM Fusion"
        sudo dnf install -y distribution-gpg-keys
        sudo rpmkeys --import "/usr/share/distribution-gpg-keys/rpmfusion/RPM-GPG-KEY-rpmfusion-free-fedora-$(rpm -E %fedora)"
        sudo rpmkeys --import "/usr/share/distribution-gpg-keys/rpmfusion/RPM-GPG-KEY-rpmfusion-nonfree-fedora-$(rpm -E %fedora)"
        sudo dnf install --setopt=localpkg_gpgcheck=1 \
            "https://mirrors.ustc.edu.cn/rpmfusion/free/fedora/rpmfusion-free-release-$(rpm -E %fedora).noarch.rpm" \
            "https://mirrors.ustc.edu.cn/rpmfusion/nonfree/fedora/rpmfusion-nonfree-release-$(rpm -E %fedora).noarch.rpm"

        # Fedora 41+
        sudo dnf config-manager setopt fedora-cisco-openh264.enabled=1
        success "RPM Fusion installed and GPG keys imported."
    fi
fi

# --- Mirror 切换 ---
case "$mirror" in
ustc)
    step "Applying USTC mirrors..."
    if [[ "$repo" == "all" || "$repo" == "fedora" ]]; then
        # https://mirrors.ustc.edu.cn/help/fedora.html
        sudo sed -e 's|^metalink=|#metalink=|g' \
            -e 's|^#baseurl=http://download.example/pub/fedora/linux|baseurl=https://mirrors.ustc.edu.cn/fedora|g' \
            -e 's|^#baseurl=http.*/fedora|baseurl=https://mirrors.ustc.edu.cn/fedora|g' \
            -e 's|^baseurl=http.*/fedora|baseurl=https://mirrors.ustc.edu.cn/fedora|g' \
            -i.bak \
            /etc/yum.repos.d/fedora.repo \
            /etc/yum.repos.d/fedora-updates.repo
    fi

    if [[ "$repo" == "all" || "$repo" == "rpmfusion" ]]; then
        # https://mirrors.ustc.edu.cn/help/rpmfusion.html
        sudo sed -e 's|^metalink=|#metalink=|g' \
            -e 's|^#baseurl=http://download1.rpmfusion.org|baseurl=https://mirrors.ustc.edu.cn/rpmfusion|g' \
            -e 's|^#baseurl=http.*/rpmfusion|baseurl=https://mirrors.ustc.edu.cn/rpmfusion|g' \
            -e 's|^baseurl=http.*/rpmfusion|baseurl=https://mirrors.ustc.edu.cn/rpmfusion|g' \
            -i.bak \
            /etc/yum.repos.d/rpmfusion*.repo
    fi
    success "Mirror switched to USTC."
    ;;
tsinghua)
    step "Applying Tsinghua mirrors..."
    if [[ "$repo" == "all" || "$repo" == "fedora" ]]; then
        # https://mirrors.tuna.tsinghua.edu.cn/help/fedora/
        sudo sed -e 's|^metalink=|#metalink=|g' \
            -e 's|^#baseurl=http://download.example/pub/fedora/linux|baseurl=https://mirrors.tuna.tsinghua.edu.cn/fedora|g' \
            -e 's|^#baseurl=http.*/fedora|baseurl=https://mirrors.tuna.tsinghua.edu.cn/fedora|g' \
            -e 's|^baseurl=http.*/fedora|baseurl=https://mirrors.tuna.tsinghua.edu.cn/fedora|g' \
            -i.bak \
            /etc/yum.repos.d/fedora.repo \
            /etc/yum.repos.d/fedora-updates.repo
    fi

    if [[ "$repo" == "all" || "$repo" == "rpmfusion" ]]; then
        # https://mirrors.tuna.tsinghua.edu.cn/help/rpmfusion/
        sudo sed -e 's|^metalink=|#metalink=|g' \
            -e 's|^#baseurl=http://download1.rpmfusion.org|baseurl=https://mirrors.tuna.tsinghua.edu.cn/rpmfusion|g' \
            -e 's|^#baseurl=http.*/rpmfusion|baseurl=https://mirrors.tuna.tsinghua.edu.cn/rpmfusion|g' \
            -e 's|^baseurl=http.*/rpmfusion|baseurl=https://mirrors.tuna.tsinghua.edu.cn/rpmfusion|g' \
            -i.bak \
            /etc/yum.repos.d/rpmfusion*.repo
    fi
    success "Mirror switched to Tsinghua."
    ;;

official)
    step "Restoring official mirrors..."
    if [[ "$repo" == "all" || "$repo" == "fedora" ]]; then
        sudo sed -e 's|^#metalink=|metalink=|g' \
            -e 's|^baseurl=|#baseurl=|g' \
            -i.bak \
            /etc/yum.repos.d/fedora.repo \
            /etc/yum.repos.d/fedora-updates.repo
    fi

    if [[ "$repo" == "all" || "$repo" == "rpmfusion" ]]; then
        sudo sed -e 's|^#metalink=|metalink=|g' \
            -e 's|^baseurl=|#baseurl=|g' \
            -i.bak \
            /etc/yum.repos.d/rpmfusion*.repo
    fi
    success "Official mirrors restored."
    ;;
esac

# --- DNF.conf 配置 ---
if $config; then
    task "Applying custom DNF policy"
    step "Locking kernel updates (exclude=kernel*)"
    echo "$defaults_dnfconf" | sudo tee /etc/dnf/dnf.conf >/dev/null
    success "Custom dnf.conf applied successfully."
fi

# --- 清理无用 Repo ---
if $clean; then
    task "Cleaning up unused repositories"
    chrome_repo=/etc/yum.repos.d/google-chrome.repo
    pycharm_repo=/etc/yum.repos.d/_copr:copr.fedorainfracloud.org:phracek:PyCharm.repo
    nvidia_repo=/etc/yum.repos.d/rpmfusion-nonfree-nvidia-driver.repo
    [[ -f "${chrome_repo}" ]] && sudo mv "${chrome_repo}" "${chrome_repo}.bak"
    [[ -f "${pycharm_repo}" ]] && sudo mv "${pycharm_repo}" "${pycharm_repo}.bak"
    if ! lspci | grep -q -i nvidia; then
        [[ -f "${nvidia_repo}" ]] && sudo mv "${nvidia_repo}" "${nvidia_repo}.bak"
    fi
    success "Unused repositories disabled (.bak)."
fi

if ! $no_option; then
    exit 0
fi

# --- Summary 部分 ---
section "DNF System Summary"

task "DNF Repolist"
sudo dnf repolist

task "Repository Status"
if [[ -f "/etc/yum.repos.d/google-chrome.repo" ]]; then
    warn "Google Chrome repo is still active."
else
    success "Third-party repos cleared."
fi

# 镜像状态检查
if grep --quiet "^baseurl=.*ustc" /etc/yum.repos.d/fedora.repo; then
    item "Current Fedora Mirror: ${FG_GREEN}USTC${C_RESET}"
elif grep --quiet "^baseurl=.*tsinghua" /etc/yum.repos.d/fedora.repo; then
    item "Current Fedora Mirror: ${FG_GREEN}Tsinghua${C_RESET}"
elif grep --quiet "^metalink=.*fedoraproject.org" /etc/yum.repos.d/fedora.repo; then
    item "Current Fedora Mirror: ${FG_GREEN}Official${C_RESET}"
fi

# RPM Fusion 检查
if rpm --quiet -q rpmfusion-free-release; then
    item "RPM Fusion: ${FG_GREEN}Installed${C_RESET}"
else
    item "RPM Fusion: ${FG_RED}Not Installed${C_RESET}"
fi

task "Current dnf.conf Content"
paragraph "$(cat /etc/dnf/dnf.conf)"

echo
echo "${C_DIM}--- End of Summary ---${C_RESET}"
