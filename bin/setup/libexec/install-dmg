#!/usr/bin/env bash
# https://github.com/kovidgoyal/kitty/releases/download/v0.45.0/kitty-0.45.0.dmg
# https://github.com/Hammerspoon/hammerspoon/releases/download/1.0.0/Hammerspoon-1.0.0.zip

# é»˜è®¤é…ç½®
ALLOW_GLOBAL=false
TARGET_DIR="$HOME/Applications"
TMP_DIR=$(mktemp -d "${TMPDIR:-/tmp}/dmg.XXXXXX")
mkdir -p "$TMP_DIR"

# # 0. å‡†å¤‡ç”¨æˆ·ç›®å½•
# MOUNT_POINT="$TMP_DIR/mount"
# mkdir -p "$MOUNT_POINT"

# 1. å‚æ•°è§£æ
usage() {
    echo "ç”¨æ³•: $0 [-g] <path_to_dmg>"
    echo "  -g : å…è®¸ .pkg å®‰è£…åˆ°ç³»ç»Ÿæ ¹ç›®å½• (éœ€è¦ sudo)"
    exit 1
}

while getopts "g" opt; do
    case $opt in
    g) ALLOW_GLOBAL=true ;;
    *) usage ;;
    esac
done
shift $((OPTIND - 1))

DMG_URL="$1"
DMG_PATH=
# 1. ä¸‹è½½ï¼ˆå¦‚æœæ˜¯ URLï¼‰
if [[ $DMG_URL =~ ^https?:// ]]; then
    DMG_PATH="$TMP_DIR/$(basename "$DMG_URL")"
    echo "â†“ ä¸‹è½½ $DMG_URL"
    curl -L -o "$DMG_PATH" "$DMG_URL"
else
    DMG_PATH="$DMG_URL"
fi

if [[ -z "$DMG_PATH" ]]; then usage; fi

# echo "âï¸  æŒ‚è½½ $DMG_PATH"
# hdiutil attach "$DMG_PATH" -nobrowse -mountpoint "$MOUNT_POINT"

# 2. æŒ‚è½½é•œåƒ
echo "ğŸ” æ­£åœ¨è§£æ: $(basename "$DMG_PATH")..."
MOUNT_INFO=$(hdiutil attach -nobrowse -noverify -accept-eula -plist "$DMG_PATH" 2>/dev/null)
MOUNT_POINT=$(echo "$MOUNT_INFO" | grep -A 1 "mount-point" | grep string | sed 's/<[^>]*>//g' | xargs)
# MOUNT_POINT=$(echo "$MOUNT_INFO" | plutil -extract 0."mount-point" raw -)

if [[ -z "$MOUNT_POINT" ]]; then
    echo "âŒ æŒ‚è½½å¤±è´¥"
    exit 1
fi

# 3. å®‰è£…é€»è¾‘
install_success=false
APP_PATH=$(find "$MOUNT_POINT" -maxdepth 2 -name "*.app" -print -quit)
PKG_PATH=$(find "$MOUNT_POINT" -maxdepth 2 -name "*.pkg" -print -quit)

if [[ -n "$APP_PATH" ]]; then
    # .app å§‹ç»ˆå®‰å…¨åœ°å®‰è£…åˆ° $HOME
    APP_NAME=$(basename "$APP_PATH")
    echo "ğŸ“¦ å®‰è£… APP åˆ° $TARGET_DIR..."

    # ä½¿ç”¨ rsync ç¡®ä¿æƒé™å’Œå®Œæ•´æ€§
    rm -rf "${TARGET_DIR:?}/$APP_NAME"
    rsync -a "$APP_PATH/" "$TARGET_DIR/$APP_NAME/"

    # ç§»é™¤éš”ç¦»ä½ (Gatekeeper ä¿®å¤)
    xattr -rd com.apple.quarantine "$TARGET_DIR/$APP_NAME" 2>/dev/null
    install_success=true

elif [[ -n "$PKG_PATH" ]]; then
    echo "ğŸ“¦ æ£€æµ‹åˆ° PKG: $(basename "$PKG_PATH")"

    # æ£€æŸ¥æ˜¯å¦æ”¯æŒç”¨æˆ·ç›®å½•
    SUPPORT_USER=$(installer -query domaintargets -pkg "$PKG_PATH" 2>/dev/null | grep "CurrentUserHomeDirectory")

    if [[ -n "$SUPPORT_USER" ]]; then
        echo "âœ… åŒ…æ”¯æŒç”¨æˆ·ç›®å½•å®‰è£…ï¼Œæ­£åœ¨å®‰è£…è‡³ $HOME..."
        installer -pkg "$PKG_PATH" -target "$HOME"
        install_success=true
    elif [[ "$ALLOW_GLOBAL" = true ]]; then
        echo "ğŸš€ æ­£åœ¨é€šè¿‡ -g å¼ºåˆ¶å®‰è£…è‡³ç³»ç»Ÿç›®å½• (/)ï¼Œå¯èƒ½éœ€è¦å¯†ç ..."
        sudo installer -pkg "$PKG_PATH" -target /
        install_success=true
    else
        echo "âŒ é”™è¯¯: è¯¥ PKG æ— æ³•å®‰è£…åˆ°ç”¨æˆ·ç›®å½•ï¼Œä¸”æœªæŒ‡å®š -g å‚æ•°å…è®¸å…¨å±€å®‰è£…ã€‚"
        install_success=false
    fi
fi

# 4. å¼ºåˆ¶å¸è½½æ¸…ç†
echo "âï¸  å¸è½½é•œåƒ"
hdiutil detach "$MOUNT_POINT" -force -quiet

# 5. ç»“æœåé¦ˆ
if [[ "$install_success" = true ]]; then
    echo "âœ¨ å®‰è£…æˆåŠŸï¼å»ºè®®ä» $TARGET_DIR å¯åŠ¨åº”ç”¨ã€‚"
    exit 0
else
    echo "ğŸš¨ å®‰è£…æœªèƒ½å®Œæˆã€‚"
    exit 1
fi
