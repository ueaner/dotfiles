#!/usr/bin/env bash
# Set a Login/Lock Screen/Desktop background image for Sway.

set_sway_bg() {
    BACKGROUND_PATH=$1

    # swaymsg "output * bg $BACKGROUND_PATH fill"
    tee ~/.config/sway/config.d/40-output-background.conf >/dev/null <<EOT
output * bg $BACKGROUND_PATH fill
EOT

    # swaylock -i "$BACKGROUND_PATH" --scaling=fill
    tee ~/.config/swaylock/config >/dev/null <<EOT
image=$BACKGROUND_PATH
scaling=fill
EOT

    if grep --quiet -w sddm /etc/sysconfig/desktop; then
        # theme=$(grep --color=never -r -h -P -o "^Current=\K.*" /usr/lib/sddm/sddm.conf.d/*.conf /etc/sddm.conf.d/*.conf /etc/sddm.conf)
        theme=$(find /etc/sddm.conf.d/ /usr/lib/sddm/sddm.conf.d/ /etc/sddm.conf -name "*.conf" -exec grep --color=never -h -P -o "^Current=\K.*" {} +)
        themefile="/usr/share/sddm/themes/$theme/theme.conf"
        background=$(grep --color=never -r -h -P -o "^background=\K.*" "$themefile")

        filename=$(basename "$BACKGROUND_PATH")
        dir=$(dirname "$background")
        bgpath="$dir/sway-$filename"

        if sudo sed -i "s|^background=.*$|background=$bgpath|" "$themefile"; then
            sudo cp "$BACKGROUND_PATH" "$bgpath"
        fi
    fi
}

paths=(
    ~/.local/share/backgrounds/f42-01-night.jxl
    ~/.local/share/backgrounds/f37-01-night.webp
)

for p in "${paths[@]}"; do
    if [[ -f "$p" ]]; then
        if set_sway_bg "$p"; then
            exit 0
        fi
    fi
done
