#!/usr/bin/env bash
# 开始录屏，可选择全屏/局部，以及含声/无声
# @depends: libnotify, wf-recorder, slurp

echo "[$$ sway-recording] ---------- $(date +"%Y-%m-%d %T.%6N") ----------" >>/tmp/xreaker.log

ICON=~/.local/share/fa-icons/video.svg

# --- Dependency Check ---
if ! command -v wf-recorder >/dev/null; then
    notify-send -i $ICON -u critical "Recording Error" "wf-recorder not found. Please install it."
    exit 1
fi
if ! command -v slurp >/dev/null; then
    notify-send -i $ICON -u critical "Recording Error" "slurp not found. Please install it."
    exit 1
fi

# --- 配置 ---
RECORDINGS_DIR="${XDG_VIDEOS_DIR:-$HOME/Videos}/Recordings"
mkdir -p "$RECORDINGS_DIR"

VIDEO_EXT="mkv"
FILENAME="Recording_$(date +'%Y-%m-%d-%H%M%S.%N').$VIDEO_EXT"
FILEPATH="$RECORDINGS_DIR/$FILENAME"
RECORDER_LOG="/tmp/wf-recorder.log"

RECORD_ACTION="$1"
shift

# 只要存在 wf-recorder 进程则不启动新的进程（无论是通过当前脚本启动的，还是外部其他方式启动的）
PID=$(pgrep wf-recorder)
if [[ -n "$PID" ]]; then
    notify-send -i $ICON -u critical "Recording Error" \
        "Recording (PID: $PID) already in progress. Stop the current recording first."
    exit 1
fi

# --- Execution Logic ---
case "$RECORD_ACTION" in
"output_noaudio")
    # Execute wf-recorder in background
    nohup wf-recorder -f "$FILEPATH" 1>$RECORDER_LOG 2>&1 &

    echo "[$$ sway-recording] Recording Started, Process Details: $(pgrep --list-full wf-recorder)." >>/tmp/xreaker.log
    ;;
"area_noaudio")
    nohup wf-recorder -g "$(slurp)" -f "$FILEPATH" 1>$RECORDER_LOG 2>&1 &
    ;;
"output_audio")
    nohup wf-recorder -a -f "$FILEPATH" 1>$RECORDER_LOG 2>&1 &
    ;;
"area_audio")
    nohup wf-recorder -g "$(slurp)" -a -f "$FILEPATH" 1>$RECORDER_LOG 2>&1 &
    ;;
*)
    notify-send -i $ICON -u critical "Recording Error" "Invalid action: $RECORD_ACTION"
    exit 1
    ;;
esac

# 录屏期间，通知 waybar 每秒更新 custom/recorder 模块
TIMER_PID_FILE=/tmp/rec-timer.pid
(
    while pgrep -x wf-recorder >/dev/null; do
        pkill -RTMIN+8 waybar
        sleep 1
    done
    rm -f "$TIMER_PID_FILE" # 录屏结束自己清理
) &
echo $! >"$TIMER_PID_FILE"
