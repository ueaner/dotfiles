#!/usr/bin/env bash
# 智能切换当前聚焦的 tmux/kitty 布局，否则切 Sway 容器分屏方向。

log() { printf "[$$ sway-tmux-layout] %s\n" "$*" >>/tmp/xreaker.log; }
log "$(date +"%F %T.%6N")"

# ---------- tmux ----------
tmux_switch_layout() {
    local app_id=$1 pid=$2

    # 1. 终端类型检查
    [[ "$app_id" =~ ^(Alacritty|foot|footclient)$ ]] || return 1
    # 2. 终端里跑着 tmux 且 pane 数 >1
    pgrep -P "$pid" | xargs -r ps -o comm= | grep -q tmux || return 1
    [[ $(tmux list-panes 2>/dev/null | wc -l) -gt 1 ]] || return 1
    # 3. 全窗口(zoom)时不处理
    [[ $(tmux display-message -p '#{window_zoomed_flag}') == "0" ]] || return 1

    log "change tmux layout"
    tmux next-layout
}

# ---------- kitty ----------
kitty_switch_layout() {
    [[ "$1" == "kitty" ]] || return 1 # app_id 检查

    local socket
    socket="/tmp/mykitty-$PID"
    [[ ! -S "$socket" ]] && socket=$(ls -t /tmp/mykitty-* 2>/dev/null | head -n1)
    # 确保 kitty socket 存在
    [[ -S $socket ]] || return 1
    local kitty_cmd="kitty @ --to unix:$socket"

    # 打开了多个 windows
    local win_count
    win_count=$($kitty_cmd ls | jq -r '.[0].tabs[] | select(.is_focused==true) | .windows | length')
    [[ $win_count -gt 1 ]] || return 1

    local info current enabled_str count
    info=$(
        $kitty_cmd ls | jq -r '.[0].tabs[] | select(.is_focused==true)
            | .enabled_layouts as $all
            | ($all | map(select(. != "stack"))) as $filtered
            | "\(.layout) \($filtered | join(",")) \($filtered | length)"
        '
    )

    current=$(cut -d' ' -f1 <<<"$info")
    enabled_str=$(cut -d' ' -f2 <<<"$info")
    count=$(cut -d' ' -f3 <<<"$info")

    # 当前是 stack 布局或 除 stack 外只剩 ≤1 个可用布局，不切换
    [[ $current == "stack" || $count -le 1 ]] && return 1

    # 计算下一个布局
    IFS=',' read -ra layouts <<<"$enabled_str"
    local next i
    for i in "${!layouts[@]}"; do
        [[ ${layouts[i]} == "$current" ]] || continue
        # 循环切换布局
        idx=$(((i + 1) % ${#layouts[@]}))
        next=${layouts[idx]}
        break
    done

    # 执行布局切换
    log "change kitty layout: $current -> $next"
    $kitty_cmd goto-layout "$next"
}

# ---------- main ----------
read -r app_id pid < <(swaymsg -t get_tree | jq -r '
    .. | select(.type?) | select(.focused==true) | [.app_id, .pid] | join(" ")
')

log "sway focused app_id: $app_id, pid: $pid"

# 依次尝试
tmux_switch_layout "$app_id" "$pid" && exit 0
kitty_switch_layout "$app_id" && exit 0

# 兜底 sway
log "change sway container layout"
swaymsg layout toggle split
