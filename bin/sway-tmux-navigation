#!/usr/bin/env bash
# Smart arrow-key navigation across tmux panes, browser address bar, and Sway containers.
# Depends: jq, libnotify, wtype

log() { printf "[$$ sway-tmux-navigation] %s\n" "$*" >>/tmp/xreaker.log; }
log "$(date +"%F %T.%6N")"

DIRECTION="$1"
case "$DIRECTION" in
    left)  TMUX_EDGE="pane_at_left"   ; TMUX_DIR="L"; KITTY_DIR="left"  ; SWAY_DIR="left"  ;;
    down)  TMUX_EDGE="pane_at_bottom" ; TMUX_DIR="D"; KITTY_DIR="bottom"; SWAY_DIR="down"  ;;
    up)    TMUX_EDGE="pane_at_top"    ; TMUX_DIR="U"; KITTY_DIR="top"   ; SWAY_DIR="up"    ;;
    right) TMUX_EDGE="pane_at_right"  ; TMUX_DIR="R"; KITTY_DIR="right" ; SWAY_DIR="right" ;;
    *)
        notify-send "sway-tmux-navigation: invalid direction \"$DIRECTION\""
        exit 1
        ;;
esac

read -r APP_ID PID < <(swaymsg -t get_tree | jq -r '.. | select(.type? and .focused==true) | "\(.app_id) \(.pid)"')

log "sway focused app_id: $APP_ID, pid: $PID"

# 1. 在终端中使用 Tmux
if [[ "$APP_ID" =~ ^(Alacritty|foot|footclient)$ ]] && pgrep -P "$PID" | xargs ps -o comm= | grep -q "tmux"; then
    # 获取 tmux 状态：是否在边缘，以及 pane 数量
    read -r IS_AT_EDGE PANE_COUNT < <(tmux display-message -p "#{${TMUX_EDGE}} #{window_panes}")

    if [[ "$PANE_COUNT" -gt 1 && "$IS_AT_EDGE" == "0" ]]; then
        log "Switching tmux pane: $DIRECTION"
        tmux select-pane -"$TMUX_DIR"
        exit $?
    fi

# 2. Kitty 原生分屏
elif [[ "$APP_ID" == "kitty" ]]; then
    socket="/tmp/mykitty-$PID"
    [[ ! -S "$socket" ]] && socket=$(ls -t /tmp/mykitty-* 2>/dev/null | head -n1)
    # 确保 kitty socket 存在
    if [[ -S $socket ]]; then
    kitty_cmd="kitty @ --to unix:$socket"
        # 获取当前 tab 的布局和窗口数量
        read -r KITTY_LAYOUT WINDOW_COUNT < <($kitty_cmd ls | jq -r '
            .[].tabs[] | select(.is_focused==true) | "\(.layout) \( .windows | length )"
        ')

        # 非 stack 布局，多个窗口
        if [[ "$KITTY_LAYOUT" != "stack" && "$WINDOW_COUNT" -gt 1 ]]; then
            # 尝试移动，如果成功则退出脚本
            if $kitty_cmd focus-window --match "neighbor:$KITTY_DIR" 2>/dev/null; then
                log "Kitty move: $DIRECTION"
                exit 0
            fi
        fi
        log "Kitty at edge (Layout: $KITTY_LAYOUT, Windows: $WINDOW_COUNT), falling back to Sway"
    fi

# 3. 浏览器聚焦地址栏
elif [[ "$APP_ID" =~ ^(org.mozilla.firefox|google-chrome)$ && "$DIRECTION" == "right" ]]; then
    HAS_RIGHT=$(swaymsg -t get_tree | jq -r '
        . as $tree | (..|select(.focused?==true)) as $f
        | .. | select(.type?=="workspace" and any(.nodes[]?; .id==$f.id))
        | if .layout=="splith" and .nodes[-1].id != $f.id then "yes" else "no" end
    ')

    if [[ "$HAS_RIGHT" == "no" ]]; then
        log "Focusing browser address bar"
        # 模拟按下 Ctrl+L 聚焦地址栏
        wtype -M ctrl -P l -m ctrl -p l || notify-send "sway-tmux-navigation: wtype failed"
        exit $?
    fi
fi

# 4. 默认切换 Sway 容器
log "Switching sway container: $DIRECTION"
swaymsg focus "$SWAY_DIR" >/dev/null
