#!/usr/bin/env bash
# Quick switch or move-to the rightmost / first empty workspace in Sway.
# @depends: jq, libnotify

echo "[$$ sway-workspace] ---------- $(date +"%Y-%m-%d %T.%6N") ----------" >>/tmp/xreaker.log

subcmd="$1"
empty_id=
nodes_count=

read -r focused_id max_id holes nums_str <<<"$(
    swaymsg -t get_workspaces |
        jq -r '
            (map(.num) | sort) as $nums
            | ($nums | max) as $max
            | ($nums | length) as $total
            | (.[] | select(.focused == true) | .num) as $focused
            | [$focused, $max, $max - $total, ($nums | join(" "))] | @tsv
        '
)"

nodes_count=$(
    swaymsg -t get_tree |
        jq --argjson idx "$focused_id" '
            .. | objects
            | select(.type=="workspace" and .num==$idx)
            | ((.nodes + .floating_nodes) | length)
        '
)

# 1. 当前 workspace 内无窗口, 使用当前 workspace
[[ $nodes_count -eq 0 ]] && empty_id=$focused_id

if [[ -z "$empty_id" ]]; then
    # 把空格分隔的编号读进数组
    read -ra nums <<<"$nums_str"

    # 2. 存在间断 workspace
    for ((i = 1; i <= max_id; i++)); do
        [[ ${nums[i - 1]} -eq $i ]] && continue
        empty_id=$i
        break
    done

    # 3. 开启新的 workspace
    [[ -z "$empty_id" ]] && empty_id=$((max_id + 1))
fi

echo "[$$ sway-workspace] subcmd: $subcmd, focused_id: $focused_id, max_id: $max_id, nums: $nums_str, empty_id: $empty_id" >>/tmp/xreaker.log

case "$subcmd" in
# for workspace
switch-to-rightmost)
    swaymsg workspace "$max_id"
    ;;
switch-to-empty)
    swaymsg workspace "$empty_id"
    ;;

# for container
move-to-rightmost)
    # 当前窗口已经在 rightmost workspace
    if [[ "$max_id" == "$focused_id" ]]; then
        exit 0
    fi

    swaymsg "move container to workspace $max_id; workspace $max_id"
    ;;
move-to-empty)
    # 无间断, 最后一个 workspace 单窗口, 不新建不必要的 workspace
    if [[ "$holes" -eq 0 && "$max_id" == "$focused_id" && "$nodes_count" -eq 1 ]]; then
        exit 0
    fi

    swaymsg "move container to workspace $empty_id; workspace $empty_id"
    ;;
*)
    notify-send "[$$ sway-workspace] argument must be one of 'switch-to-rightmost | switch-to-empty | move-to-rightmost | move-to-empty'"
    exit 1
    ;;
esac
