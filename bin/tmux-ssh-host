#!/usr/bin/env bash
# 获取指定 tmux pane 中 ssh 目标主机名

log() { printf "[%s tmux-ssh-host] %s\n" "$(date +"%F %T.%6N")" "$*" >>/tmp/xreaker.log; }

pane_pid=${1:-}

# 1. 找到该终端下的前台进程
tty_dev=$(ps -o tty= -p "$pane_pid" | tr -d ' ')
[[ -n "$tty_dev" ]] || exit 0

fg_pid=$(ps -o pid= -t "$tty_dev" | awk '$1 != '"$pane_pid"' {print $1; exit}')
[[ -n "$fg_pid" ]] || exit 0

# 2. 获取完整命令行并校验
cmdline=$(ps -o args= -p "$fg_pid")
[[ $cmdline == "ssh "* ]] || exit 0

# 3. 解析 SSH 目标
# 使用 set 将 cmdline 拆解为位置参数，$1 为 'ssh'
# shellcheck disable=SC2086
set -- $cmdline
# 使用 ssh -G 获取原始（即 ssh config 中）定义的 Host 别名
host=$("$@" -G 2>/dev/null | grep '^host ' | awk '{print $2}')

log "pane_pid: $pane_pid, fg_pid: $fg_pid, host: $host"

# 4. 输出并处理（去掉可能存在的 user@）
if [[ -n "$host" ]]; then
    echo "${host##*@}"
else
    echo "ssh"
fi
